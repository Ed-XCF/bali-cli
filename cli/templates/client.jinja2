import logging
from typing import Dict

from grpc import insecure_channel
from google.protobuf.json_format import MessageToDict
from . import {{ filename }}_pb2, {{ filename }}_pb2_grpc, {{ filename }}_schema
from .. import GRPC_ADDRESS, GRPC_LOGGER

logger = logging.getLogger(GRPC_LOGGER)


class {{ service }}Client:
    URL = f"{GRPC_ADDRESS['host']}:{GRPC_ADDRESS['port']}"
{% for method in methods %}
    def {{ method[0] | decamelize }}(self{% if method[1] == "google.protobuf.Empty" %}{% else %}, schema: {{ filename }}_schema.{{ method[1] }}{% endif %}) -> {{ filename }}_schema.{{ method[2] }}:
        with insecure_channel(self.URL) as channel:
            stub = {{ filename }}_pb2_grpc.{{ service }}Stub(channel)
    {% if method[1] == "google.protobuf.Empty" %}
            response = stub.{{ method[0] }}()
    {% else %}
            payload = schema.dict()
            logger.info("greeting rpc send: %s", payload)
            request = {{ filename }}_pb2.{{ method[1] }}(**payload)
            response = stub.{{ method[0] }}(request)
    {% endif %}
            rely = MessageToDict(response, True, True)
            logger.info("greeting rpc received: %s", rely)
            return {{ filename }}_schema.{{ method[2] }}(**rely)
{% endfor %}
