import logging
from typing import Dict
from inspect import currentframe

from grpc import insecure_channel
from google.protobuf.json_format import MessageToDict
from . import {{ filename }}_pb2, {{ filename }}_pb2_grpc, {{ filename }}_schema
from .. import GRPC_ADDRESS, GRPC_LOGGER

logger = logging.getLogger(GRPC_LOGGER)


class {{ service }}Client:
    URL = f"{GRPC_ADDRESS['host']}:{GRPC_ADDRESS['port']}"
{% for method in methods %}
    def {{ method[0] | decamelize }}(self{% if method[1] == "google.protobuf.Empty" %}{% else %}, schema: {{ filename }}_schema.{{ method[1] }}{% endif %}) -> {{ filename }}_schema.{{ method[2] }}:
        with insecure_channel(self.URL) as channel:
            stub = {{ filename }}_pb2_grpc.{{ service }}Stub(channel)
            class_name, func_name = type(self).__name__, currentframe().f_code.co_name
    {% if method[1] == "google.protobuf.Empty" %}
            logger.info("gRPC client %s.%s send nothing", class_name, func_name)
            response = stub.{{ method[0] }}()
    {% else %}
            payload = schema.dict()
            logger.info("{gRPC client %s.%s send: %s", class_name, func_name, payload)
            request = {{ filename }}_pb2.{{ method[1] }}(**payload)
            response = stub.{{ method[0] }}(request)
    {% endif %}
            rely = MessageToDict(response, True, True)
            logger.info("gRPC client %s.%s received: %s", class_name, func_name, rely)
            return {{ filename }}_schema.{{ method[2] }}(**rely)
{% endfor %}
